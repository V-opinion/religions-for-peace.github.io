(function(window,factory){if(typeof define=='function'&&define.amd){define(factory)}else if(typeof module=='object'&&module.exports){module.exports=factory()}else{window.FA_ImageList=factory()}}(window,function factory(){function FA_ImageList(options){this.options={};this.option(options);this.colcade=[];this.pages_loaded=[];this.images_loaded=[];this.resizeObserver={};this.observer=new IntersectionObserver((entries)=>{entries.forEach((entry)=>{if(entry.isIntersecting){entry.target.classList.remove("overflown");if(entry.target.classList.contains("last")){let page_id=parseInt(entry.target.id.substr(0,entry.target.id.indexOf("i")));this.loadImagePage(page_id+1);entry.target.classList.remove("last")}}else{entry.target.classList.add("overflown")}})},{threshold:[0,1]});this.create()}let proto=FA_ImageList.prototype;proto.option=function(options){this.options=extend(this.options,options)};proto.create=function(){document.documentElement.style.setProperty("--image-item-width",this.options.imgBaseWidth+"px");this.loadImagesColumn();this.colcade=new Colcade(this.options.containerElem,{columns:this.options.columns,items:this.options.items,});this.loadImagePage();this.registerObserver()};proto.registerObserver=function(){let parent=this;this.resizeObserver=new ResizeObserver(function(){parent.ROCallback()});this.resizeObserver.observe(this.options.container)};proto.makeImgElement=function(img){let calc_height=Math.ceil((this.options.imgBaseWidth*img.height)/img.width);let div2_elem=document.createElement("div");div2_elem.classList.add("image_item");div2_elem.style.aspectRatio=img.width/img.height;let img_elem=document.createElement("img");if(img.url.endsWith(".webp")){img_elem.src=img.url}else{img_elem.src=img.url.replace(/https?:\/\//,this.options.path2img+(img.url.startsWith('https')?'':'h/')+(this.options.imgBaseWidth+this.options.extraPadding)+"x/",img.url)}img_elem.addEventListener("error",function(){this.src=img.url;this.onerror=div2_elem.remove()},{once:true});img_elem.setAttribute("loading","lazy");img_elem.setAttribute("height",calc_height);img_elem.setAttribute("width",this.options.imgBaseWidth);img_elem.setAttribute("alt",img.topic_title);let a_elem=document.createElement("a");a_elem.href=img.topic_url;a_elem.classList.add("text_overlay");a_elem.setAttribute("style","width: 100%; width: -moz-available; width: -webkit-fill-available; width: fill-available;");let div_text=document.createElement("div");div_text.classList.add("innerTitle");let div_title=document.createElement("div");let inner_elem_text=document.createTextNode(img.topic_title+"\u00A0\u00A0");div_title.appendChild(inner_elem_text);div_title.title=img.topic_title;div_title.style.minWidth=(this.options.imgBaseWidth-16)+"px";div_text.appendChild(div_title);a_elem.appendChild(div_text);div2_elem.appendChild(img_elem);div2_elem.appendChild(a_elem);this.observer.observe(div2_elem);return div2_elem};proto.loadImagePage=function(page_number=0,append=true){let parent=this;if(!parent.pages_loaded.includes(page_number)){if(parent.options.maxImgPerFrame===0||page_number<parent.options.maxImgPerFrame){fetch("/images?json=1&page="+page_number).then(function(response){if(response.ok)return response.json();else throw new Error("Got an error while fetching images")}).then(function(jsonList){if(jsonList[0]){let iterations=jsonList[0].length;for(let i in jsonList[0]){let imgElem=parent.makeImgElement(jsonList[0][i]);parent.images_loaded.push(imgElem);imgElem.id=page_number.toString()+"i"+i.toString();if(!--iterations){imgElem.classList.add("last")}if(append)parent.colcade.append(imgElem);else parent.colcade.prepend(imgElem)}}});parent.pages_loaded.push(page_number)}}};proto.countColumnsToRender=function(){return Math.floor(this.options.container.offsetWidth/(this.options.imgBaseWidth+this.options.extraPadding))};proto.loadImagesColumn=function(){let columnToRender=this.countColumnsToRender();let newWidth=this.options.imgBaseWidth+Math.floor((this.options.container.offsetWidth%(this.options.imgBaseWidth+this.options.extraPadding))/columnToRender);document.documentElement.style.setProperty("--image-item-width",newWidth+"px");for(let i=0;i<columnToRender;i++){let divColumns=document.createElement("div");divColumns.classList.add("image_column");this.options.container.appendChild(divColumns)}};proto.ROCallback=function(){if(this.colcade){let columnsRendered=document.getElementsByClassName("image_column");let columnCount=columnsRendered.length;let columnToRender=this.countColumnsToRender();let newWidth=this.options.imgBaseWidth+Math.floor((this.options.container.offsetWidth%(this.options.imgBaseWidth+this.options.extraPadding))/columnToRender);document.documentElement.style.setProperty("--image-item-width",newWidth+"px");if(columnCount!==columnToRender){while(columnsRendered[0]){columnsRendered[0].parentNode.removeChild(columnsRendered[0])}this.colcade.destroy();if(this.options.limitDisplay===0){location.hash=this.options.containerElem}if(this.pages_loaded.length>1){this.resizeObserver.disconnect();this.observer.disconnect();delete this;new FA_ImageList(this.options)}else{this.loadImagesColumn();this.colcade=new Colcade(this.options.containerElem,{columns:this.options.columns,items:this.options.items,});for(let i in this.images_loaded){this.colcade.append(this.images_loaded[i])}}}}};function extend(a,b){for(let prop in b){a[prop]=b[prop]}return a}return FA_ImageList}));